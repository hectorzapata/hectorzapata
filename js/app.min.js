function pintarMarcador(a,b,c){leibol="img/cliente.png","co"==b&&(leibol="img/conductor.png");var d=new google.maps.Marker({position:a,icon:leibol,title:c,map:map});return d}function calcularRutas(){$.each(datos.conductores,function(a,b){b.totales=Object.keys(datos.clientes).length,datos.conductores[a].rutas={},$.each(datos.clientes,function(c,d){datos.conductores[a].rutas[c]={},calcularRuta(b.marcador.getPosition(),d.marcador.getPosition(),b.nombre,d.nombre)})})}function calcularRuta(a,b,c,d){ds=new google.maps.DirectionsService,ds.route({origin:a,destination:b,travelMode:google.maps.TravelMode.WALKING},function(e,f){if(e&&"OK"==f){var g=datos.conductores[c];if(g.contador++,g.rutas[d].response=e,g.rutas[d].distancia=e.routes[0].legs[0].distance,g.rutas[d].tiempoLlegada=e.routes[0].legs[0].duration,$("#tr_"+c+" .porcentaje").progress({percent:parseInt(100*g.contador/g.totales)}),g.contador==g.totales){var h=datos.conductores[c].rutas,i=Object.keys(h)[0];$.each(h,function(a,b){b.distancia.value<h[i].distancia.value&&(i=a)}),i={cmc:i,d:h[i].distancia.text,tdl:h[i].tiempoLlegada.text},llenarFila(i,c)}}f===google.maps.DirectionsStatus.OVER_QUERY_LIMIT?setTimeout(function(){calcularRuta(a,b,c,d)},200):f!==google.maps.DirectionsStatus.OK&&console.log("Directions request failed due to "+f,c,d)})}function mostrarRuta(a){if(!$(a).hasClass("loading")){var b=$(a).parent().siblings(".cmc").html(),c=$(a).parent().siblings(".n").html();null==directionsDisplay.getMap()&&directionsDisplay.setMap(map),directionsDisplay.setDirections(datos.conductores[c].rutas[b].response)}}function llenarFila(a,b){$("#tr_"+b+" .cmc").html(a.cmc),$("#tr_"+b+" .d").html(a.d),$("#tr_"+b+" .tdl").html(a.tdl),$("#tr_"+b+" .button").toggle(),$("#tr_"+b+" .porcentaje").toggle(),0==$(".porcentaje:visible").length&&(taimaut=1e4,i=1,$(".pausar").show(),avanzar())}function avanzar(){intervalo=setInterval(function(){i++,$(".barraEspera").progress({percent:i})},100),to=setTimeout(function(){directionsDisplay.setMap(null),$.ajax({url:rutaAvanzar,type:"GET"}).done(function(a){repintar(a)}).fail(function(a){console.log("error",a)}),clearInterval(intervalo)},taimaut)}function pausar(a){0==$(".acciones .porcentaje:visible").length&&($(a).hasClass("pausar")?($(a).hide(),$(".reanudar").show(),clearInterval(intervalo),clearTimeout(to)):($(a).hide(),$(".pausar").show(),taimaut=1e4-100*i,avanzar()))}function repintar(a){$.each(a,function(a,b){if("cl"==b.tipo){var c=datos.clientes[b.nombre];if(c){var d=new google.maps.LatLng(b.lat,b.lng);c.marcador.setPosition(d)}}else{var c=datos.conductores[b.nombre];if(c){var d=new google.maps.LatLng(b.lat,b.lng);c.marcador.setPosition(d),$("#tr_"+c.nombre+" .button").toggle(),$("#tr_"+c.nombre+" .porcentaje").toggle(),$("#tr_"+c.nombre+" .porcentaje").progress({percent:0}),c.contador=0}}}),calcularRutas()}var pause=!1,lat=23.7348644;long=-99.1430382,n=1;var myLatlng=new google.maps.LatLng(lat,long),directionsDisplay=new google.maps.DirectionsRenderer,mapOptions={zoom:13,center:myLatlng},intervalo,taimaut,i,to,map,datos,totales;$(document).ready(function(){datos=$.parseJSON($("#datos").val()),map=new google.maps.Map(document.getElementById("map"),mapOptions),directionsDisplay.setMap(map),$.each(datos.clientes,function(a,b){b.marcador=pintarMarcador(new google.maps.LatLng(b.lat,b.lng),b.tipo,b.nombre)}),$.each(datos.conductores,function(a,b){b.marcador=pintarMarcador(new google.maps.LatLng(b.lat,b.lng),b.tipo,b.nombre),b.contador=0,b.totales=0}),calcularRutas()});
